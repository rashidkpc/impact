<div class="relay" ng-controller="relay">
  <h1 ng-show="impact > -1">
    <strong>{{(impact/config.goal)*100 | number: 1}}%</strong>
    <small>project health over last 1d</small>
  </h1>
  <p>Points measure the relative value of events stored in elasticsearch. Points are determined by tunable blocks. To add a block or influence the weight of a block on the point value see the <code>blocks/</code> directory.</p>
  <div class="row">
    <div class="col-md-7 relay-charts">
      <h4>Project Health</h4>
      <div ng-if="config" chart="burn" height=150 max=100></div>
      <h4>Activity</h4>
      <div ng-if="config" chart="timeline" height=150></div>
      <h4>Recent Events</h4>
      <div>
        <table class="table table-condensed table-striped">
          <thead>
            <tr>
              <th>Timestamp</th>
              <th colspan=2>Actor</th>
              <th>Points</th>
              <th>Details</th>
            </tr>
          </thead>
          <tr ng-repeat="event in events">
            <td>{{event._timestamp|date:'short'}}</td>
            <td width="1%"><img class="avatar" height=20 width=20 src="https://avatars.githubusercontent.com/{{event._actor || event._source.actor.login}}"></td>
            <td>{{event._actor || event._source.actor.login}}</td>
            <td>{{event._score}}</td>
            <td>
              <span ng-repeat="block in event.blocks">
                <i class="fa fa-circle" style="color: {{block.color}}"></i>
                <span ng-bind-html='block.toHTML(event)|trustAsHtml'></span>
              </span>

            </td>
          </tr>
        </table>

      </div>
    </div>
    <div class="col-md-5">
      <h4>Blocks</h4>
      <table class="table table-striped">
        <thead>
          <tr>
            <th colspan=2>Block</th>
            <th>Events</th>
            <th>Points</th>
            <th>% of Health</th>
          </tr>
        </thead>
        <tr ng-repeat="block in blocks | orderBy:'name'">
          <td><i class="fa fa-circle" style="color: {{block.blockDef.color}}"></i></td>
          <td>{{block.name}}</td>
          <td>{{block.count}}</td>
          <td>{{block.impact|number:1}}</td>
          <td width="60%">
            <div class="impact-container">
              <!--
              <div class="impact-rank"
                style="width: {{100 * block.impact_percent * (100 / block.blockDef.importance) }}%; background-color: {{block.blockDef.color}}">
              </div>
              -->
              <div class="impact-rank"
                style="width: {{100 * block.impact_percent * (100/((impact/config.goal)*100))}}%; background-color: {{block.blockDef.color}}">
              </div>


            </div>
          </td>

        </tr>
      </table>


      <h4>Actors</h4>
      <form>
        <input placeholder="Filter actors ..." ng-model="actorFilter" class="form-control">
      </form>
      <table class="table table-striped">
        <thead>
          <tr>
            <th colspan=2>Actor</th>
            <th>Events</th>
            <th>Points</th>
            <th>Block Distribution</th>
          </tr>
        </thead>
        <tr ng-repeat="actor in actors | filter:actorFilter | limitTo:config.actors.list_length | orderBy:'name'">
          <td width="1%">
            <img class="avatar" height=20 width=20 src="https://avatars.githubusercontent.com/{{actor.name}}">
          </td>
          <td>
            {{actor.name}}
          </td>
          <td width="1%">
            {{actor.count}}
          </td>
          <td width="1%">
            {{actor.impact | number:1}}
          </td>
          <td width="60%">
            <div class="impact-container">
              <div class="impact-rank" style="width: {{100 * (actor.impact / actors[0].impact)}}%">
                <kbn-tooltip text="{{block.count}} {{block.name}} ({{(block.impact / actor.impact) * 100 | number:0}}%)" placement="bottom" append-to-body="1"
                  class="impact-block"
                  ng-repeat="block in actor.explanation.blocks"
                  ng-show="block.count > 0"
                  style="width: {{100 * (block.impact / actor.impact)}}%; background-color: {{blockDefs[block.name].color}}; height: 100%">
                </kbn-tooltip>
              </div>
            </div>
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>
